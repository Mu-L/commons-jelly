<?xml version="1.0"?>

<!--
This test shows coordinating between 2 threads using
mutexes with wait/notify. Numbers between threads
should increment together.
-->

<jelly xmlns="jelly:core" xmlns:threads="jelly:threads">

    <!-- get the mutex -->
    <threads:mutex var="mutex"/>

    <threads:thread var="thread1">
        <set var="counter1" value="0"/>

        <!-- get the mutex -->
        <threads:synchronize mutex="${mutex}">
            <!-- loop -->
            <while test="${counter1 != 20}">

<whitespace>
counter1: ${counter1}
</whitespace>

                <set var="counter1" value="${counter1+1}"/>

                <!-- let the other thread proceed -->
                <threads:notify mutex="${mutex}"/>

                <!-- wait for 1 iteration of the other thread -->
                <threads:wait mutex="${mutex}"/>
            </while>

            <!-- let the other thread proceed -->
            <threads:notify mutex="${mutex}"/>

        </threads:synchronize>
    </threads:thread>

    <threads:thread var="thread2">
        <set var="counter2" value="0"/>
        <threads:sleep for="100"/>
        <!-- get the mutex -->
        <threads:synchronize mutex="${mutex}">
            <!-- loop -->
            <while test="${counter2 != 20}">

<whitespace>
counter2: ${counter2}
</whitespace>

                <set var="counter2" value="${counter2+1}"/>

                <!-- let the other thread proceed -->
                <threads:notify mutex="${mutex}"/>

                <!-- wait for 1 iteration of the other thread -->
                <threads:wait mutex="${mutex}"/>
            </while>

            <!-- let the other thread proceed -->
            <threads:notify mutex="${mutex}"/>

        </threads:synchronize>
    </threads:thread>

<whitespace>
[main]: waiting for threads to finish
</whitespace>

    <threads:join thread="${thread1}"/>
    <threads:join thread="${thread2}"/>

<whitespace>
[main]: threads are now done
</whitespace>

</jelly>