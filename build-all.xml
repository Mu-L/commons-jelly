<?xml version="1.0" encoding="UTF-8"?>

<project default="jar" name="commons-jelly-build-all" basedir=".">

  <!-- 
    Documentation:
    
    call "clean jar" to build Jelly and each taglib from scratch.
    If you don't call clean first, you can get a false positive;
    if the "depends" of a jar-* task is incomplete, the build might
    pull in an older jar.
    
    Also, will copy all built jars into each successive build, so
    it's possible for a tag to build successfully without declaring
    all its dependencies, if its dependencies happen to have been built
    first.
    
    WRITTEN FOR SIMPLICITY, NOT ENFORCING STRICTNESS.
    
    when adding tags to the build, add them to the "subexec" target and
    add a jar-<tagName> target.
  -->

  <!-- 
    target that can be used via antcall task
    to call a single target on all jelly build.xml scripts
  -->
  <target name="subexec">
    <ant dir="." target="${sub.target}"/>
    <ant dir="jelly-tags/ant" target="${sub.target}"/>
    <ant dir="jelly-tags/junit" target="${sub.target}"/>
    <ant dir="jelly-tags/util" target="${sub.target}"/>
  </target>
  
  <target name="clean">
    <antcall target="subexec">
      <param name="sub.target" value="clean"/>
    </antcall>
  </target>
  
  <target name="jar" depends="jar-jelly,jar-ant,jar-junit,jar-util"/>
    
  <target name="jar-jelly">
    <echo message="Building Jelly..."/>
    <ant dir="." target="jar"/>
  </target>
  
  <target name="jar-ant" depends="jar-jelly,jar-util,jar-junit">
    <antcall target="taglib-template">
      <param name="sub.taglib" value="ant"/>
    </antcall>
  </target>
  
  <target name="jar-junit" depends="jar-jelly">
    <antcall target="taglib-template">
      <param name="sub.taglib" value="junit"/>
    </antcall>
  </target>
  
  <target name="jar-util" depends="jar-jelly,jar-junit">
    <antcall target="taglib-template">
      <param name="sub.taglib" value="util"/>
    </antcall>
  </target>
  
  <!-- don't call directly, called inside jar-* tasks -->
  <target name="taglib-template">
    <echo message="Building &quot;${sub.taglib}&quot; taglib..."/>
    
    <antcall target="prepare-taglib-deps">
      <param name="sub.taglib" value="${sub.taglib}"/>
    </antcall>
    
    <!-- copy in other Jelly taglib dependencies -->
    <antcall target="get-ext-taglibs">
      <param name="sub.taglib" value="${sub.taglib}"/>
    </antcall>
    
    <antcall target="build-taglib">
      <param name="sub.taglib" value="${sub.taglib}"/>
    </antcall>
  </target>
  
  <!-- don't call directly, called inside jar-* tasks -->
  <target name="prepare-taglib-deps">
    <ant dir="jelly-tags/${sub.taglib}" target="get-deps"/>
    
    <delete>
      <fileset dir="jelly-tags/${sub.taglib}/lib" includes="commons-jelly-*"/>
    </delete>
    <copy todir="jelly-tags/${sub.taglib}/lib">
      <fileset dir="target" includes="commons-jelly-*.jar"/>
    </copy>
  </target>
  
  <!-- don't call directly, called inside jar-* tasks -->
  <target name="get-ext-taglibs">
    <copy todir="jelly-tags/${sub.taglib}/lib" flatten="true">
      <fileset dir="." includes="jelly-tags/*/target/commons-jelly-*.jar"/>
    </copy>
  </target>
  
  <!-- don't call directly, called inside jar-* tasks -->
  <target name="build-taglib">
    <ant dir="jelly-tags/${sub.taglib}" target="jar">
      <property name="noget" value="true"/>
    </ant>
  </target>
  
    
</project>
    