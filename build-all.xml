<?xml version="1.0" encoding="UTF-8"?>

<project default="jar" name="commons-jelly-build-all" basedir=".">

  <!-- 
    target that can be used via antcall task
    to call a single target on all jelly build.xml scripts
  -->
  <target name="subexec">
    <ant dir="." target="${sub.target}"/>
    <ant dir="jelly-tags/ant" target="${sub.target}"/>
    <ant dir="jelly-tags/junit" target="${sub.target}"/>
    <ant dir="jelly-tags/util" target="${sub.target}"/>
  </target>
  
  <target name="clean">
    <antcall target="subexec">
      <param name="sub.target" value="clean"/>
    </antcall>
  </target>
  
  <target name="jar">
    <antcall target="jar-all"/>
  </target>
  
  <target name="jar-all" depends="jar-jelly,jar-ant,jar-junit,jar-util"/>
  
  <!-- don't call directly, called inside jar-* tasks -->
  <target name="prepare-taglib-deps">
    <ant dir="jelly-tags/${sub.taglib}" target="get-deps"/>
    
    <delete>
      <fileset dir="jelly-tags/${sub.taglib}/lib" includes="commons-jelly-*"/>
    </delete>
    <copy todir="jelly-tags/${sub.taglib}/lib">
      <fileset dir="target" includes="commons-jelly-*.jar"/>
    </copy>
  </target>
  
  <!-- don't call directly, called inside jar-* tasks -->
  <target name="get-ext-taglib">
    <copy todir="jelly-tags/${sub.taglib}/lib">
      <fileset dir="jelly-tags/${sub.taglib.ext}/target" includes="commons-jelly-*.jar"/>
    </copy>
  </target>
  
  <!-- don't call directly, called inside jar-* tasks -->
  <target name="build-taglib">
    <ant dir="jelly-tags/${sub.taglib}" target="jar">
      <property name="noget" value="true"/>
    </ant>
  </target>
  
  <target name="jar-jelly">
    <echo message="Building Jelly..."/>
    <ant dir="." target="jar"/>
  </target>
  
  <target name="jar-ant" depends="jar-jelly,jar-util,jar-junit">
    <echo message="Building Ant taglib..."/>
    
    <antcall target="prepare-taglib-deps">
      <param name="sub.taglib" value="ant"/>
    </antcall>
    
    <!-- copy in other Jelly taglib dependencies -->
    <antcall target="get-ext-taglib">
      <param name="sub.taglib" value="ant"/>
      <param name="sub.taglib.ext" value="util"/>
    </antcall>
    <antcall target="get-ext-taglib">
      <param name="sub.taglib" value="ant"/>
      <param name="sub.taglib.ext" value="junit"/>
    </antcall>
    
    <antcall target="build-taglib">
      <param name="sub.taglib" value="ant"/>
    </antcall>
  </target>
  
  <target name="jar-util" depends="jar-jelly,jar-junit">
    <echo message="Building Util taglib..."/>
    
    <antcall target="prepare-taglib-deps">
      <param name="sub.taglib" value="util"/>
    </antcall>
    
    <!-- copy in other Jelly taglib dependencies -->
    <antcall target="get-ext-taglib">
      <param name="sub.taglib" value="util"/>
      <param name="sub.taglib.ext" value="junit"/>
    </antcall>
    
    <antcall target="build-taglib">
      <param name="sub.taglib" value="util"/>
    </antcall>
  </target>
  
  <target name="jar-junit" depends="jar-jelly">
    <echo message="Building JUnit taglib..."/>
    
    <antcall target="prepare-taglib-deps">
      <param name="sub.taglib" value="junit"/>
    </antcall>
    
    <antcall target="build-taglib">
      <param name="sub.taglib" value="junit"/>
    </antcall>
    
  </target>
    
</project>
    